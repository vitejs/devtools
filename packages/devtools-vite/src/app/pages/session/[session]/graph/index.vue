<script setup lang="ts">
import type { SessionContext } from '~~/shared/types'
import type { ClientSettings } from '~/state/settings'
import { useRoute, useRouter } from '#app/composables/router'
import { clearUndefined, toArray } from '@antfu/utils'
import { computedWithControl, debouncedWatch, onClickOutside } from '@vueuse/core'
import Fuse from 'fuse.js'
import { computed, ref } from 'vue'
import { settings } from '~/state/settings'
import { parseReadablePath } from '~/utils/filepath'
import { getFileTypeFromModuleId, ModuleTypeRules } from '~/utils/icon'

const props = defineProps<{
  session: SessionContext
}>()

const route = useRoute()
const router = useRouter()

const searchValue = ref<{
  search: string
  selected: string[] | null
  [key: string]: any
}>({
  search: (route.query.search || '') as string,
  selected: (route.query.file_types ? toArray(route.query.file_types) : null) as string[] | null,
  node_modules: (route.query.node_modules ? toArray(route.query.node_modules) : null) as string[] | null,
})

const moduleViewTypes = [
  {
    label: 'List',
    value: 'list',
    icon: 'i-carbon-list',
  },
  {
    label: 'Detailed List',
    value: 'detailed-list',
    icon: 'i-carbon-list-boxes',
  },
  {
    label: 'Graph',
    value: 'graph',
    icon: 'i-ph-graph-duotone',
  },
  {
    label: 'Folder',
    value: 'folder',
    icon: 'i-ph-folder-duotone',
  },
] as const

debouncedWatch(
  searchValue.value,
  (f) => {
    const query: any = {
      ...route.query,
      search: f.search || undefined,
      file_types: f.selected || undefined,
      node_modules: f.node_modules || undefined,
    }
    router.replace({
      query: clearUndefined(query),
    })
  },
  { debounce: 500 },
)

const parsedPaths = computed(() => props.session.modulesList.map((mod) => {
  const path = parseReadablePath(mod.id, props.session.meta.cwd)
  const type = getFileTypeFromModuleId(mod.id)
  return {
    mod,
    path,
    type,
  }
}))

const searchFilterTypes = computed(() => {
  return ModuleTypeRules.filter((rule) => {
    return parsedPaths.value.some(mod => rule.match.test(mod.mod.id))
  })
})

const allNodeModules = computed(() => {
  const nodeModules = new Set<string>()
  for (const mod of parsedPaths.value) {
    if (mod.path.moduleName)
      nodeModules.add(mod.path.moduleName)
  }
  return Array.from(nodeModules).sort()
})

const filtered = computed(() => {
  let modules = parsedPaths.value
  if (searchValue.value.selected) {
    modules = modules.filter((mod) => {
      const type = getFileTypeFromModuleId(mod.mod.id)
      return searchValue.value.selected!.includes(type.name)
    })
  }
  if (searchValue.value.node_modules) {
    modules = modules.filter(mod => mod.path.moduleName && searchValue.value.node_modules!.includes(mod.path.moduleName))
  }
  return modules.map(mod => ({ ...mod.mod, path: mod.path.path }))
})

const fuse = computedWithControl(
  () => filtered.value,
  () => new Fuse(filtered.value, {
    includeScore: true,
    keys: ['id'],
    ignoreLocation: true,
    threshold: 0.4,
  }),
)

const searched = computed(() => {
  if (!searchValue.value.search) {
    return filtered.value
  }
  return fuse.value
    .search(searchValue.value.search)
    .map(r => r.item)
})

function toggleDisplay(type: ClientSettings['moduleGraphViewType']) {
  if (route.query.module) {
    router.replace({ query: { ...route.query, module: undefined } })
  }
  settings.value.moduleGraphViewType = type
}

function toggleNodeModule(moduleName: string) {
  if (!searchValue.value.node_modules) {
    searchValue.value.node_modules = allNodeModules.value.filter((m: string) => m !== moduleName)
  }
  else if (searchValue.value.node_modules.includes(moduleName)) {
    searchValue.value.node_modules = searchValue.value.node_modules.filter((m: string) => m !== moduleName)
  }
  else {
    searchValue.value.node_modules.push(moduleName)
  }
  if (searchValue.value.node_modules.length === allNodeModules.value.length) {
    searchValue.value.node_modules = null
  }
}

function isNodeModuleSelected(moduleName: string) {
  return !searchValue.value.node_modules || searchValue.value.node_modules.includes(moduleName)
}

function reverseNodeModules() {
  if (searchValue.value.node_modules?.length === allNodeModules.value.length) {
    searchValue.value.node_modules = null
  }
  else if (searchValue.value.node_modules == null) {
    searchValue.value.node_modules = []
  }
  else {
    searchValue.value.node_modules = allNodeModules.value.filter(m => !searchValue.value.node_modules?.includes(m))
  }
}

function unselectAllNodeModules() {
  if (searchValue.value.node_modules?.length === 0) {
    searchValue.value.node_modules = null
  }
  else {
    searchValue.value.node_modules = []
  }
}

const showNodeModulesDropdown = ref(false)
const dropdownRef = ref<HTMLElement>()

onClickOutside(dropdownRef, () => {
  showNodeModulesDropdown.value = false
})
</script>

<template>
  <div relative max-h-screen of-hidden>
    <div absolute left-4 top-4 z-panel-nav>
      <DataSearchPanel v-model="searchValue" :rules="searchFilterTypes">
        <div v-if="allNodeModules.length" ref="dropdownRef" flex="~ gap-2 items-center" p2 border="t base" relative>
          <span op50 pl2 text-sm>Packages</span>
          <button
            btn-action
            flex="~ items-center gap-1"
            @click="showNodeModulesDropdown = !showNodeModulesDropdown"
          >
            <div i-ph-package-duotone />
            <span text-sm>
              {{ searchValue.node_modules ? `${searchValue.node_modules.length} selected` : 'All' }}
            </span>
            <div :class="showNodeModulesDropdown ? 'i-ph-caret-up' : 'i-ph-caret-down'" text-xs />
          </button>
          <div
            v-if="showNodeModulesDropdown"
            absolute top-full left-0 mt-1 z-100
            border="~ base rounded-xl" bg-glass
            max-h-80 of-auto
            min-w-60 max-w-90vw
            shadow-lg
          >
            <div flex="~ col gap-2" p2>
              <div flex="~ gap-2 items-center" border="b base" pb2>
                <button
                  text-xs op50 px2 py1
                  hover="bg-active"
                  rounded-md
                  @click="reverseNodeModules"
                >
                  Reverse
                </button>
                <button
                  text-xs op50 px2 py1
                  hover="bg-active"
                  rounded-md
                  @click="unselectAllNodeModules"
                >
                  {{ searchValue.node_modules?.length === 0 ? 'Select All' : 'Unselect All' }}
                </button>
              </div>
              <label
                v-for="moduleName of allNodeModules"
                :key="moduleName"
                border="~ base rounded-md" px2 py1
                flex="~ items-center gap-1"
                select-none cursor-pointer
                hover="bg-active"
                :class="isNodeModuleSelected(moduleName) ? 'bg-active' : 'grayscale op50'"
              >
                <input
                  type="checkbox"
                  mr1
                  :checked="isNodeModuleSelected(moduleName)"
                  @change="toggleNodeModule(moduleName)"
                >
                <div text-sm>{{ moduleName }}</div>
              </label>
            </div>
          </div>
        </div>
        <div flex="~ gap-2 items-center" p2 border="t base">
          <span op50 pl2 text-sm>View as</span>
          <button
            v-for="viewType of moduleViewTypes"
            :key="viewType.value"
            btn-action
            :class="settings.moduleGraphViewType === viewType.value ? 'bg-active' : 'grayscale op50'"
            @click="toggleDisplay(viewType.value)"
          >
            <div :class="viewType.icon" />
            {{ viewType.label }}
          </button>
        </div>
      </DataSearchPanel>
    </div>
    <template v-if="settings.moduleGraphViewType === 'list'">
      <div of-auto h-screen pt-45>
        <ModulesFlatList
          :session="session"
          :modules="searched"
        />
        <div
          absolute bottom-4 py-1 px-2 bg-glass left="1/2" translate-x="-1/2" border="~ base rounded-full" text="center xs"
        >
          <span op50>{{ searched.length }} of {{ session.modulesList.length }}</span>
        </div>
      </div>
    </template>
    <template v-else-if="settings.moduleGraphViewType === 'detailed-list'">
      <div of-auto h-screen pt-45>
        <ModulesDetailedList
          :session="session"
          :modules="searched"
        />
        <div
          absolute bottom-4 py-1 px-2 bg-glass left="1/2" translate-x="-1/2" border="~ base rounded-full" text="center xs"
        >
          <span op50>{{ searched.length }} of {{ session.modulesList.length }}</span>
        </div>
      </div>
    </template>
    <template v-else-if="settings.moduleGraphViewType === 'graph'">
      <ModulesGraph
        :session="session"
        :modules="searched"
      />
    </template>
    <template v-else>
      <ModulesFolder
        :session="session"
        :modules="searched"
      />
    </template>
  </div>
</template>
